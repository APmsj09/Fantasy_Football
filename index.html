<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Football Draft Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .roster-card ul {
            max-height: 200px;
            overflow-y: auto;
        }
        /* Custom scrollbar for better aesthetics */
        .table-container::-webkit-scrollbar, .roster-card ul::-webkit-scrollbar {
            width: 8px;
            background-color: #f1f1f1;
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-thumb, .roster-card ul::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Tailwind gray-300 */
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-thumb:hover, .roster-card ul::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8; /* Tailwind gray-400 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Fantasy Football Draft Assistant</h1>
            <p class="text-lg text-gray-600 mt-2">12-Team Snake Draft Edition</p>
        </header>

        <!-- Modal for Team Names -->
        <div id="team-name-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Enter Team Names</h3>
                    <div id="team-name-inputs" class="mt-2 px-7 py-3 space-y-2 text-left">
                        <!-- Inputs will be generated here -->
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="start-draft-button" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                            Start Draft
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Left Column: Controls and Instructions -->
            <div class="md-col-span-1 bg-white p-6 rounded-lg shadow-md self-start">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Draft Controls</h2>
                <div class="space-y-4">
                    <!-- Option 1: Upload File -->
                    <div>
                        <label for="data-file" class="block text-sm font-medium text-gray-700 mb-1">1a. Upload Player TSV File</label>
                        <input type="file" id="data-file" accept=".tsv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <hr class="flex-grow border-gray-300">
                        <span class="text-xs text-gray-500 font-semibold">OR</span>
                        <hr class="flex-grow border-gray-300">
                    </div>

                    <!-- Option 2: Load from GitHub -->
                    <div>
                        <button id="load-data-button" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">1b. Load Player Data from GitHub</button>
                    </div>
                    
                    <button id="setup-draft-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">2. Setup 12-Team Draft</button>

                     <div class="flex space-x-2">
                        <button id="save-draft" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Save Draft</button>
                        <button id="load-draft" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Load Draft</button>
                     </div>
                     <!-- New Undo Button -->
                     <div>
                        <button id="undo-pick-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 mt-2">Undo Last Pick</button>
                     </div>
                </div>

                <!-- Filter and Sort Controls (Moved to Left Column) -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-lg mb-2">Filter & Sort Players</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="player-search" class="block text-sm font-medium text-gray-700">Search Player:</label>
                            <input type="text" id="player-search" placeholder="e.g., Mahomes" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="position-filter" class="block text-sm font-medium text-gray-700">Filter by Position:</label>
                            <select id="position-filter" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white">
                                <option value="">All Positions</option>
                                <option value="QB">QB</option>
                                <option value="RB">RB</option>
                                <option value="WR">WR</option>
                                <option value="TE">TE</option>
                                <option value="PK">PK</option>
                                <option value="Def">Def</option>
                            </select>
                        </div>
                        <div>
                            <label for="sort-by" class="block text-sm font-medium text-gray-700">Sort By:</label>
                            <select id="sort-by" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white">
                                <option value="VBD" selected>VBD (Highest First)</option>
                                <option value="2025 Projected Fantasy Points">Proj. Points (Highest First)</option>
                                <option value="Player">Player Name (A-Z)</option>
                                <option value="Pos">Position (A-Z)</option>
                                <option value="Team">Team (A-Z)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="draft-status" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                    <h3 class="font-semibold text-lg mb-2">Draft Status</h3>
                    <div class="space-y-1 text-sm">
                        <p><strong>Round:</strong> <span id="current-round">N/A</span></p>
                        <p><strong>Pick:</strong> <span id="current-pick-number">N/A</span></p>
                        <p class="text-lg font-bold text-indigo-600"><strong>On the Clock:</strong> <span id="on-the-clock">N/A</span></p>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold text-md mb-2">Upcoming Picks:</h4>
                        <ul id="upcoming-picks" class="text-sm list-disc list-inside space-y-0.5">
                            <!-- Upcoming picks will be listed here -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Right Column: Draft Board and Rosters -->
            <div class="md:col-span-2 space-y-8">
                <!-- Available Players (Now includes "Best Players" concept via sorting) -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Available Players</h2>
                    <div class="table-container border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Team</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bye</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proj. Pts</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VBD</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="players-body" class="bg-white divide-y divide-gray-200">
                                <!-- Player rows will be inserted here -->
                            </tbody>
                        </table>
                        <p id="no-available-players" class="text-center text-gray-500 p-4 hidden">No players available based on current filters.</p>
                    </div>
                </div>

                <!-- Team Rosters -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Team Rosters</h2>
                    <div id="rosters-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Roster cards will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let players = []; // This array will hold all available player data.
        let teams = {}; // { "Team Name": { roster: [player1], positions: {QB:1, RB:2...} } }
        let draftOrder = [];
        let currentPick = 0;
        let draftStarted = false;
        // History of draft picks for undo functionality
        let draftHistory = []; // Stores { pickIndex, player, teamName } for each drafted player

        // --- ROSTER SETTINGS ---
        const rosterSettings = {
            QB: { min: 0, max: 1 },
            RB: { min: 2, max: 4 },
            WR: { min: 2, max: 4 },
            TE: { min: 1, max: 3 },
            PK: { min: 0, max: 1 },
            Def: { min: 0, max: 1 },
            totalStarters: 10,
            bench: 6,
            totalSize: 16
        };

        // --- DOM ELEMENTS ---
        const fileInput = document.getElementById('data-file');
        const playersBody = document.getElementById('players-body'); // Main player table body
        // Removed bestPlayersBody as it's no longer a separate section
        const rostersContainer = document.getElementById('rosters-container');
        const saveButton = document.getElementById('save-draft');
        const loadButton = document.getElementById('load-draft');
        const undoButton = document.getElementById('undo-pick-button');
        const setupDraftButton = document.getElementById('setup-draft-button');
        const modal = document.getElementById('team-name-modal');
        const teamNameInputsContainer = document.getElementById('team-name-inputs');
        const startDraftButton = document.getElementById('start-draft-button');
        const draftStatusDiv = document.getElementById('draft-status');
        const currentRoundSpan = document.getElementById('current-round');
        const currentPickNumberSpan = document.getElementById('current-pick-number');
        const onTheClockSpan = document.getElementById('on-the-clock');
        const loadDataButton = document.getElementById('load-data-button');
        const upcomingPicksList = document.getElementById('upcoming-picks');
        const playerSearchInput = document.getElementById('player-search');
        const positionFilterSelect = document.getElementById('position-filter');
        const sortBySelect = document.getElementById('sort-by');
        const noAvailablePlayersMessage = document.getElementById('no-available-players');
        // Removed noBestPlayersMessage

        // --- Hard-coded URL for your TSV file ---
        // IMPORTANT: Replace this with the raw URL of your TSV file from your private GitHub repository
        const tsvFileUrl = 'https://github.com/APmsj09/Fantasy_Football/blob/main/Data.tsv';


        // --- EVENT LISTENERS ---
        fileInput.addEventListener('change', handleFileUpload);
        saveButton.addEventListener('click', saveDraft);
        loadButton.addEventListener('click', loadDraft);
        undoButton.addEventListener('click', undoLastPick);
        setupDraftButton.addEventListener('click', showTeamNameModal);
        startDraftButton.addEventListener('click', startDraft);
        loadDataButton.addEventListener('click', loadPlayersFromGitHub);
        
        playerSearchInput.addEventListener('input', applyFiltersAndSort);
        positionFilterSelect.addEventListener('change', applyFiltersAndSort);
        sortBySelect.addEventListener('change', applyFiltersAndSort);

        /**
         * Handles local data file upload and parsing.
         * Populates the 'players' array.
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                players = parseTSV(text); // Update the global players array
                applyFiltersAndSort(); // Render players with default filters/sort
                alert('Player data uploaded successfully from your device!');
            };
            reader.readAsText(file);
        }
        
        /**
         * Fetches and loads player data from the hard-coded GitHub URL.
         * Populates the 'players' array.
         */
        function loadPlayersFromGitHub() {
            fetch(tsvFileUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok. Please ensure the file URL is correct and you are logged into GitHub to access private repositories.');
                    }
                    return response.text();
                })
                .then(text => {
                    players = parseTSV(text); // Update the global players array
                    applyFiltersAndSort(); // Render players with default filters/sort
                    alert('Player data loaded successfully from GitHub!');
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                    alert('Failed to load data from GitHub. Please check your internet connection, the file URL, and ensure you are logged into GitHub.');
                });
        }

        /**
         * Parses TSV text into an array of player objects.
         * Ensures VBD and Proj. Pts are numbers.
         * @param {string} text - The TSV content.
         * @returns {Array<Object>} Array of player objects.
         */
        function parseTSV(text) {
            const rows = text.split(/\r?\n/).filter(row => row.trim() !== '');
            if (rows.length < 2) {
                alert('Data file must have a header and at least one player row.');
                return [];
            }
            const headers = rows[0].split('\t').map(h => h.trim());
            const parsedPlayers = [];
            for (let i = 1; i < rows.length; i++) {
                const values = rows[i].split('\t').map(v => v.trim());
                if (values.length === headers.length) {
                    let player = {};
                    headers.forEach((header, index) => {
                        let value = values[index];
                        // Convert numeric fields to numbers
                        if (header === '2025 Projected Fantasy Points' || header === 'VBD') {
                            player[header] = parseFloat(value) || 0; // Default to 0 if parsing fails
                        } else {
                            player[header] = value;
                        }
                    });
                    parsedPlayers.push(player);
                }
            }
            // Add a simple VBD calculation if not present, for demonstration
            if (!headers.includes('VBD')) {
                // If VBD is not in the TSV, use Projected Fantasy Points as a fallback
                parsedPlayers.forEach(p => {
                    p.VBD = p['2025 Projected Fantasy Points'] || 0;
                });
                console.warn("VBD column not found in TSV. Using '2025 Projected Fantasy Points' as VBD for sorting purposes.");
            }
            return parsedPlayers;
        }

        /**
         * Shows the modal to enter team names.
         * Logic check: Ensures players data is loaded before proceeding.
         */
        function showTeamNameModal() {
            if (players.length === 0) {
                alert('Please load player data first, either by uploading a file or by loading from GitHub.');
                return;
            }
            teamNameInputsContainer.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                teamNameInputsContainer.innerHTML += `
                    <div>
                        <label for="team-${i}" class="block text-sm font-medium text-gray-700">Team ${i}</label>
                        <input type="text" id="team-${i}" value="Team ${i}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                `;
            }
            modal.classList.remove('hidden');
        }

        /**
         * Initializes and starts the draft.
         */
        function startDraft() {
            const teamNames = [];
            for (let i = 1; i <= 12; i++) {
                const input = document.getElementById(`team-${i}`);
                if (!input.value.trim()) {
                    alert(`Please enter a name for Team ${i}.`);
                    return;
                }
                teamNames.push(input.value.trim());
            }

            // Reset state for a new draft
            teams = {};
            draftOrder = [];
            currentPick = 0;
            draftHistory = []; // Clear history for a new draft

            teamNames.forEach(name => {
                teams[name] = { roster: [], positions: {} };
            });

            for (let i = 0; i < rosterSettings.totalSize; i++) {
                const roundOrder = [...teamNames];
                if ((i + 1) % 2 === 0) {
                    roundOrder.reverse();
                }
                draftOrder.push(...roundOrder);
            }

            draftStarted = true;
            modal.classList.add('hidden');
            draftStatusDiv.classList.remove('hidden');
            updateDraftStatus();
            renderRosters();
            applyFiltersAndSort(); // Re-render players after draft starts
        }

        /**
         * Updates the UI with the current draft status and upcoming picks.
         */
        function updateDraftStatus() {
            if (!draftStarted || currentPick >= draftOrder.length) {
                onTheClockSpan.textContent = "Draft Complete!";
                currentRoundSpan.textContent = (rosterSettings.totalSize).toString();
                currentPickNumberSpan.textContent = draftOrder.length.toString();
                upcomingPicksList.innerHTML = '<li class="text-gray-500">Draft has concluded.</li>';
                return;
            }

            const round = Math.floor(currentPick / 12) + 1;
            const pickInRound = (currentPick % 12) + 1;
            const overallPick = currentPick + 1;
            const currentTeam = draftOrder[currentPick];

            currentRoundSpan.textContent = round;
            currentPickNumberSpan.textContent = `${overallPick} (${pickInRound})`;
            onTheClockSpan.textContent = currentTeam;

            // Display upcoming picks
            upcomingPicksList.innerHTML = '';
            const numberOfFuturePicks = 5; // How many future picks to show
            for (let i = 1; i <= numberOfFuturePicks; i++) {
                const futurePickIndex = currentPick + i;
                if (futurePickIndex < draftOrder.length) {
                    const futureRound = Math.floor(futurePickIndex / 12) + 1;
                    const futurePickInRound = (futurePickIndex % 12) + 1;
                    const futureTeam = draftOrder[futurePickIndex];
                    upcomingPicksList.innerHTML += `<li>Pick ${futurePickIndex + 1} (R${futureRound}, P${futurePickInRound}): ${futureTeam}</li>`;
                } else {
                    break; // Stop if no more picks in the draft order
                }
            }
            if (upcomingPicksList.innerHTML === '') {
                upcomingPicksList.innerHTML = '<li class="text-gray-500">No more future picks.</li>';
            }
        }

        /**
         * Applies current filters and sort order to the available players
         * and then renders the main players table.
         */
        function applyFiltersAndSort() {
            let filteredPlayers = [...players]; // Start with all available players

            // Apply search filter
            const searchTerm = playerSearchInput.value.toLowerCase();
            if (searchTerm) {
                filteredPlayers = filteredPlayers.filter(player =>
                    player.Player.toLowerCase().includes(searchTerm) ||
                    player.Team.toLowerCase().includes(searchTerm)
                );
            }

            // Apply position filter
            const selectedPosition = positionFilterSelect.value;
            if (selectedPosition) {
                filteredPlayers = filteredPlayers.filter(player => player.Pos === selectedPosition);
            }

            // Apply sorting
            const sortBy = sortBySelect.value;
            filteredPlayers.sort((a, b) => {
                if (sortBy === 'Player' || sortBy === 'Pos' || sortBy === 'Team' || sortBy === 'Bye Week') {
                    // Sort ascending for string values
                    return a[sortBy].localeCompare(b[sortBy]);
                } else if (sortBy === '2025 Projected Fantasy Points' || sortBy === 'VBD') {
                    // Sort descending for numerical values (highest first)
                    return b[sortBy] - a[sortBy];
                }
                return 0; // No sort applied if column not recognized
            });

            renderPlayers(filteredPlayers); // Render the filtered and sorted list
        }

        /**
         * Renders the list of available players based on the provided array.
         * Each row also has a double-click event listener.
         * @param {Array<Object>} playersToRender - The array of players to display.
         */
        function renderPlayers(playersToRender) {
            playersBody.innerHTML = '';
            if (playersToRender.length === 0) {
                noAvailablePlayersMessage.classList.remove('hidden');
            } else {
                noAvailablePlayersMessage.classList.add('hidden');
                playersToRender.forEach((player) => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-100 cursor-pointer'; // Add cursor pointer for double-click hint
                    // Double-click event listener on the row
                    // We need the original index of the player in the global 'players' array
                    tr.ondblclick = () => draftPlayer(players.indexOf(player)); 
                    
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.Player}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.Pos}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.Team}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player['Bye Week']}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player['2025 Projected Fantasy Points']}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.VBD !== undefined ? player.VBD.toFixed(2) : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900 focus:outline-none focus:ring-2 focus:ring-indigo-300 rounded-md px-2 py-1" onclick="event.stopPropagation(); draftPlayer(${players.indexOf(player)})">Draft</button>
                        </td>
                    `;
                    playersBody.appendChild(tr);
                });
            }
        }

        // Removed renderBestPlayers() as it's no longer a separate section


        /**
         * Renders the team rosters, displaying drafted players for each team.
         */
        function renderRosters() {
            rostersContainer.innerHTML = '';
            Object.keys(teams).sort().forEach(teamName => {
                const teamData = teams[teamName];
                const teamCard = document.createElement('div');
                teamCard.className = 'bg-gray-50 p-4 rounded-lg border roster-card shadow-sm';

                const posSummary = Object.entries(teamData.positions)
                                         .map(([pos, count]) => `${pos}: ${count}`)
                                         .join(', ');

                const playersHtml = teamData.roster.map(p => `
                    <li class="flex justify-between items-center text-sm border-b border-gray-200 last:border-b-0 py-1">
                        <span class="font-medium">${p.Player}</span>
                        <span class="text-gray-600">${p.Pos} - ${p.Team}</span>
                    </li>
                `).join('');

                teamCard.innerHTML = `
                    <h3 class="font-semibold text-lg mb-2">${teamName} <span class="text-sm text-gray-500">(${teamData.roster.length}/${rosterSettings.totalSize} players)</span></h3>
                    <p class="text-xs text-gray-600 mb-2">${posSummary || 'No players drafted yet'}</p>
                    <ul class="space-y-1">
                        ${playersHtml || '<li class="text-sm text-gray-500">Roster is empty.</li>'}
                    </ul>
                `;
                rostersContainer.appendChild(teamCard);
            });
        }

        /**
         * Handles drafting a player, updating team rosters, and advancing the draft.
         * Includes validation for draft status, roster limits, and position limits.
         * Records the pick in draftHistory for undo functionality.
         * @param {number} originalPlayerIndex - The original index of the player in the global 'players' array.
         */
        function draftPlayer(originalPlayerIndex) {
            if (!draftStarted) {
                alert('Please set up and start the draft first.');
                return;
            }
            if (currentPick >= draftOrder.length) {
                alert('The draft is complete! No more picks available.');
                return;
            }

            const teamName = draftOrder[currentPick];
            const teamData = teams[teamName];
            const playerToDraft = players[originalPlayerIndex]; // Get player from original array
            const position = playerToDraft.Pos;

            const currentPositionCount = teamData.positions[position] || 0;
            if (rosterSettings[position] && currentPositionCount >= rosterSettings[position].max) {
                alert(`${teamName} already has the maximum number of ${position}s allowed (${rosterSettings[position].max}). Please draft a player from a different position.`);
                return;
            }
            if (teamData.roster.length >= rosterSettings.totalSize) {
                alert(`${teamName}'s roster is full (${rosterSettings.totalSize} players). They cannot draft any more players.`);
                return;
            }

            // Record the pick in history before modifying state
            draftHistory.push({
                pickIndex: currentPick, // Store the pick index at the time of draft
                player: { ...playerToDraft }, // Store a copy of the player object
                teamName: teamName
            });

            // Add player to the team's roster
            teamData.roster.push(playerToDraft);
            // Increment the count for that position on the team
            teamData.positions[position] = (teamData.positions[position] || 0) + 1;

            // Remove the drafted player from the available players list
            players.splice(originalPlayerIndex, 1);

            // Advance the draft to the next pick
            currentPick++;

            // Re-render UI to reflect changes
            updateDraftStatus();
            applyFiltersAndSort(); // This will re-render available players
            renderRosters();
            alert(`Drafted ${playerToDraft.Player} (${playerToDraft.Pos}) to ${teamName}.`);
        }

        /**
         * Undoes the last draft pick.
         */
        function undoLastPick() {
            if (draftHistory.length === 0) {
                alert('No picks to undo!');
                return;
            }

            // Get the last recorded pick from history
            const lastPick = draftHistory.pop();
            const player = lastPick.player;
            const teamName = lastPick.teamName;

            // Revert currentPick to the state before this pick was made
            currentPick = lastPick.pickIndex;

            // Add the player back to the available players list
            players.push(player);
            // Re-sort and filter will be applied by applyFiltersAndSort later

            // Remove player from the team's roster
            const teamData = teams[teamName];
            const playerIndexInRoster = teamData.roster.findIndex(p => 
                p.Player === player.Player && p.Pos === player.Pos && p.Team === player.Team
            ); // More robust find
            if (playerIndexInRoster !== -1) {
                teamData.roster.splice(playerIndexInRoster, 1);
                // Decrement position count for the team
                teamData.positions[player.Pos] = (teamData.positions[player.Pos] || 1) - 1;
                // Clean up position entry if count becomes zero or less
                if (teamData.positions[player.Pos] <= 0) {
                    delete teamData.positions[player.Pos];
                }
            } else {
                console.warn("Player not found in roster during undo, potential state mismatch.");
            }

            // Re-render all UI components to reflect the undo
            updateDraftStatus();
            applyFiltersAndSort(); // This re-renders available players with the restored player
            renderRosters();
            alert(`Last pick (${player.Player} to ${teamName}) undone.`);
        }


        /**
         * Saves the current draft state to localStorage.
         * Now also saves draftHistory.
         */
        function saveDraft() {
            if (!draftStarted) {
                alert('No draft in progress to save.');
                return;
            }
            const draftState = {
                players,
                teams,
                draftOrder,
                currentPick,
                draftStarted,
                draftHistory // Save the draft history
            };
            localStorage.setItem('fantasyDraftState', JSON.stringify(draftState));
            alert('Draft progress saved successfully!');
        }

        /**
         * Loads a saved draft state from localStorage.
         * Now also loads draftHistory.
         */
        function loadDraft() {
            const savedState = localStorage.getItem('fantasyDraftState');
            if (savedState) {
                const draftState = JSON.parse(savedState);
                players = draftState.players;
                teams = draftState.teams;
                draftOrder = draftState.draftOrder;
                currentPick = draftState.currentPick;
                draftStarted = draftState.draftStarted;
                draftHistory = draftState.draftHistory || []; // Load history, default to empty array if not present (for older saves)

                draftStatusDiv.classList.remove('hidden');
                updateDraftStatus();
                applyFiltersAndSort(); // Re-render with loaded data
                renderRosters();
                alert('Draft progress loaded successfully!');
            } else {
                alert('No saved draft found in your browser\'s local storage.');
            }
        }
    </script>

</body>
</html>
